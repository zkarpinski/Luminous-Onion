package com.zacharykarpinski.luminousonion.model.external.trivy;

import com.fasterxml.jackson.annotation.JsonAlias;
import com.fasterxml.jackson.annotation.JsonIgnoreProperties;
import com.fasterxml.jackson.annotation.JsonProperty;
import com.zacharykarpinski.luminousonion.model.Finding;
import com.zacharykarpinski.luminousonion.model.shared.FindingSeverity;
import jakarta.persistence.Entity;
import jakarta.persistence.EnumType;
import jakarta.persistence.Enumerated;

@JsonIgnoreProperties(ignoreUnknown = true)
@Entity
public class Vulnerability extends Finding {

    @JsonAlias("Description")
    String description;
    @JsonAlias("Title")
    String title;
    @JsonAlias("PkgName")
    String packageName;
    @JsonAlias("PkgPath")
    String packagePath;
    @JsonAlias("InstalledVersion")
    String packageVersionFound;
    @JsonAlias("FixedVersion")
    String packageVersionFixed;

    @JsonAlias("VulnerabilityID")
    String findingIdentifier;

    @Enumerated(EnumType.STRING)
    FindingSeverity severity;
    String originalSeverity;
    @JsonAlias("PrimaryURL")
    private String primaryUrl;

    // Custom calculations
    // TODO: Fix title and severity not parsing as expected
    @JsonProperty("title")
    @Override
    public String getTitle() {
        return "%s:%s | %s".formatted(packageName, packageVersionFound, findingIdentifier);
    }

    public void setSeverity(String severity) {
        this.originalSeverity = severity;
        this.severity = switch (severity.toUpperCase()) {
            case ("CRITICAL") -> FindingSeverity.CRITICAL;
            case ("HIGH") -> FindingSeverity.HIGH;
            case ("MEDIUM") -> FindingSeverity.MEDIUM;
            case ("LOW") -> FindingSeverity.LOW;
            case ("NEGLIGIBLE") -> FindingSeverity.INFORMATIONAL;
            default -> FindingSeverity.INFORMATIONAL;
        };

    }
}
